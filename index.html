<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interface YOLO v5 - OpenShift AI</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }
        
        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            padding: 30px;
        }
        
        .upload-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            border: 2px dashed #dee2e6;
            transition: all 0.3s ease;
        }
        
        .upload-section.dragover {
            border-color: #007bff;
            background: #e7f3ff;
        }
        
        .config-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }
        
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #007bff;
        }
        
        .btn {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 15px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,123,255,0.3);
        }
        
        .btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }
        
        .image-preview {
            text-align: center;
            margin: 20px 0;
        }
        
        .preview-img {
            max-width: 100%;
            max-height: 300px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .results-section {
            grid-column: 1 / -1;
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-top: 20px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        
        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        
        .detection-info {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .detection-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .detection-item {
            background: #e9f4ff;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }
        
        .drag-text {
            text-align: center;
            color: #6c757d;
            font-size: 18px;
            margin: 20px 0;
        }
        
        .upload-icon {
            font-size: 48px;
            color: #007bff;
            margin-bottom: 15px;
        }
        
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
                gap: 20px;
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎯 Interface YOLO v5</h1>
            <p>Détection d'objets en temps réel avec OpenShift AI</p>
        </div>
        
        <div class="main-content">
            <!-- Section Upload -->
            <div class="upload-section" id="uploadSection">
                <div class="upload-icon">📸</div>
                <div class="drag-text">
                    Glissez votre image ici ou cliquez pour sélectionner
                </div>
                <input type="file" id="imageInput" accept="image/*" style="display: none;">
                <div class="image-preview" id="imagePreview" style="display: none;">
                    <img id="previewImg" class="preview-img" alt="Aperçu">
                    <p><strong>Image sélectionnée</strong></p>
                </div>
            </div>
            
            <!-- Section Configuration -->
            <div class="config-section">
                <h3>🔧 Configuration</h3>
                
                <div class="form-group">
                    <label for="apiUrl">URL de l'API :</label>
                    <input type="url" id="apiUrl" 
                           value="https://yolodeploimodele-yolo.apps.ocp.heritage.africa/v2/models/yolodeploimodele/infer"
                           placeholder="https://votre-api.com/infer">
                </div>
                
                <div class="form-group">
                    <label for="confidence">Seuil de confiance :</label>
                    <input type="range" id="confidence" min="0" max="1" step="0.05" value="0.2">
                    <span id="confValue">0.2</span>
                </div>
                
                <div class="form-group">
                    <label for="iou">Seuil IoU :</label>
                    <input type="range" id="iou" min="0" max="1" step="0.05" value="0.6">
                    <span id="iouValue">0.6</span>
                </div>
                
                <div class="form-group">
                    <label for="maxDetections">Détections max :</label>
                    <input type="number" id="maxDetections" value="300" min="1" max="1000">
                </div>
                
                <button class="btn" id="detectBtn" disabled>
                    🚀 Lancer la détection
                </button>
            </div>
        </div>
        
        <!-- Section Résultats -->
        <div class="results-section" id="resultsSection" style="display: none;">
            <h3>📊 Résultats de détection</h3>
            <div id="resultsContent"></div>
        </div>
    </div>

    <script>
        // Classes COCO (comme dans votre fichier coco.yaml)
        const COCO_CLASSES = [
            "person", "bicycle", "car", "motorcycle", "airplane", "bus", "train", "truck", "boat",
            "traffic light", "fire hydrant", "stop sign", "parking meter", "bench", "bird", "cat",
            "dog", "horse", "sheep", "cow", "elephant", "bear", "zebra", "giraffe", "backpack",
            "umbrella", "handbag", "tie", "suitcase", "frisbee", "skis", "snowboard", "sports ball",
            "kite", "baseball bat", "baseball glove", "skateboard", "surfboard", "tennis racket",
            "bottle", "wine glass", "cup", "fork", "knife", "spoon", "bowl", "banana", "apple",
            "sandwich", "orange", "broccoli", "carrot", "hot dog", "pizza", "donut", "cake", "chair",
            "couch", "potted plant", "bed", "dining table", "toilet", "tv", "laptop", "mouse",
            "remote", "keyboard", "cell phone", "microwave", "oven", "toaster", "sink", "refrigerator",
            "book", "clock", "vase", "scissors", "teddy bear", "hair drier", "toothbrush"
        ];

        // Variables globales
        let currentImage = null;
        let originalImageData = null;
        
        // Éléments DOM
        const uploadSection = document.getElementById('uploadSection');
        const imageInput = document.getElementById('imageInput');
        const imagePreview = document.getElementById('imagePreview');
        const previewImg = document.getElementById('previewImg');
        const detectBtn = document.getElementById('detectBtn');
        const resultsSection = document.getElementById('resultsSection');
        const confSlider = document.getElementById('confidence');
        const iouSlider = document.getElementById('iou');
        const confValue = document.getElementById('confValue');
        const iouValue = document.getElementById('iouValue');
        
        // Event listeners
        uploadSection.addEventListener('click', () => imageInput.click());
        uploadSection.addEventListener('dragover', handleDragOver);
        uploadSection.addEventListener('drop', handleDrop);
        imageInput.addEventListener('change', handleImageSelect);
        detectBtn.addEventListener('click', performDetection);
        confSlider.addEventListener('input', (e) => confValue.textContent = e.target.value);
        iouSlider.addEventListener('input', (e) => iouValue.textContent = e.target.value);
        
        // Gestion du drag & drop
        function handleDragOver(e) {
            e.preventDefault();
            uploadSection.classList.add('dragover');
        }
        
        function handleDrop(e) {
            e.preventDefault();
            uploadSection.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleImageFile(files[0]);
            }
        }
        
        function handleImageSelect(e) {
            const file = e.target.files[0];
            if (file) {
                handleImageFile(file);
            }
        }
        
        function handleImageFile(file) {
            if (!file.type.startsWith('image/')) {
                showError('Veuillez sélectionner un fichier image valide.');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = (e) => {
                previewImg.src = e.target.result;
                imagePreview.style.display = 'block';
                detectBtn.disabled = false;
                
                // Créer un canvas pour traiter l'image
                const img = new Image();
                img.onload = () => {
                    currentImage = img;
                    originalImageData = e.target.result;
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
        
        // Fonction letterbox (réplique la fonction Python)
        function letterbox(img, newShape = 640) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            const [oldH, oldW] = [img.height, img.width];
            const newH = newW = newShape;
            
            // Calculer le ratio de redimensionnement
            const r = Math.min(newH / oldH, newW / oldW);
            const [scaledW, scaledH] = [Math.round(oldW * r), Math.round(oldH * r)];
            
            // Calculer le padding
            const dw = (newW - scaledW) / 2;
            const dh = (newH - scaledH) / 2;
            
            canvas.width = newW;
            canvas.height = newH;
            
            // Remplir avec la couleur de padding (gris)
            ctx.fillStyle = 'rgb(114, 114, 114)';
            ctx.fillRect(0, 0, newW, newH);
            
            // Dessiner l'image redimensionnée
            ctx.drawImage(img, dw, dh, scaledW, scaledH);
            
            return { canvas, ratio: r, dw, dh };
        }
        
        // Préparation des données image (réplique le preprocessing Python)
        async function prepareImageData(img) {
            const { canvas, ratio, dw, dh } = letterbox(img, 640);
            const ctx = canvas.getContext('2d');
            
            // Obtenir les données des pixels
            const imageData = ctx.getImageData(0, 0, 640, 640);
            const pixels = imageData.data;
            
            // Convertir RGBA vers RGB normalisé et réorganiser en CHW
            const imgArray = new Float32Array(3 * 640 * 640);
            
            for (let i = 0; i < 640 * 640; i++) {
                const pixelIndex = i * 4;
                const r = pixels[pixelIndex] / 255.0;
                const g = pixels[pixelIndex + 1] / 255.0;
                const b = pixels[pixelIndex + 2] / 255.0;
                
                // Format CHW : [C, H, W]
                imgArray[i] = r;                    // Canal R
                imgArray[640 * 640 + i] = g;       // Canal G  
                imgArray[2 * 640 * 640 + i] = b;   // Canal B
            }
            
            return { 
                imageArray: Array.from(imgArray), 
                ratio, 
                dw, 
                dh 
            };
        }
        
        // Non-Maximum Suppression (simplifié)
        function applyNMS(detections, iouThreshold) {
            // Trier par score de confiance décroissant
            detections.sort((a, b) => b.confidence - a.confidence);
            
            const keep = [];
            const suppress = new Set();
            
            for (let i = 0; i < detections.length; i++) {
                if (suppress.has(i)) continue;
                
                keep.push(detections[i]);
                
                for (let j = i + 1; j < detections.length; j++) {
                    if (suppress.has(j)) continue;
                    
                    const iou = calculateIoU(detections[i].bbox, detections[j].bbox);
                    if (iou > iouThreshold) {
                        suppress.add(j);
                    }
                }
            }
            
            return keep;
        }
        
        // Calcul IoU
        function calculateIoU(box1, box2) {
            const [x1_1, y1_1, x2_1, y2_1] = box1;
            const [x1_2, y1_2, x2_2, y2_2] = box2;
            
            const xA = Math.max(x1_1, x1_2);
            const yA = Math.max(y1_1, y1_2);
            const xB = Math.min(x2_1, x2_2);
            const yB = Math.min(y2_1, y2_2);
            
            const intersection = Math.max(0, xB - xA) * Math.max(0, yB - yA);
            const area1 = (x2_1 - x1_1) * (y2_1 - y1_1);
            const area2 = (x2_2 - x1_2) * (y2_2 - y1_2);
            const union = area1 + area2 - intersection;
            
            return intersection / union;
        }
        
        // Fonction de détection principale
        async function performDetection() {
            if (!currentImage) {
                showError('Veuillez d\'abord sélectionner une image.');
                return;
            }
            
            const apiUrl = document.getElementById('apiUrl').value;
            const confidence = parseFloat(confSlider.value);
            const iouThreshold = parseFloat(iouSlider.value);
            const maxDet = parseInt(document.getElementById('maxDetections').value);
            
            showLoading('Traitement de l\'image en cours...');
            
            try {
                // Préparer les données image
                const { imageArray, ratio, dw, dh } = await prepareImageData(currentImage);
                
                // Préparer le payload exact comme dans votre code Python
                const payload = {
                    inputs: [{
                        name: "images",
                        shape: [1, 3, 640, 640],
                        datatype: "FP32",
                        data: imageArray
                    }]
                };
                
                // Faire la requête à l'API
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    throw new Error(`Erreur API: ${response.status} ${response.statusText}`);
                }
                
                const result = await response.json();
                
                // Traiter la réponse (réplique le post-processing Python)
                const rawOutput = result.outputs[0].data;
                const numDetections = rawOutput.length / 6; // 6 valeurs par détection
                
                const detections = [];
                for (let i = 0; i < numDetections; i++) {
                    const startIdx = i * 6;
                    const [x1, y1, x2, y2, conf, classId] = rawOutput.slice(startIdx, startIdx + 6);
                    
                    if (conf >= confidence) {
                        // Rescaler les coordonnées (inverse du letterbox)
                        const realX1 = (x1 - dw) / ratio;
                        const realY1 = (y1 - dh) / ratio;
                        const realX2 = (x2 - dw) / ratio;
                        const realY2 = (y2 - dh) / ratio;
                        
                        detections.push({
                            bbox: [realX1, realY1, realX2, realY2],
                            confidence: conf,
                            classId: Math.round(classId),
                            className: COCO_CLASSES[Math.round(classId)] || `Class ${Math.round(classId)}`
                        });
                    }
                }
                
                // Appliquer NMS
                const finalDetections = applyNMS(detections, iouThreshold).slice(0, maxDet);
                
                // Afficher les résultats
                displayResults(finalDetections, ratio, dw, dh);
                
            } catch (error) {
                console.error('Erreur lors de la détection:', error);
                showError(`Erreur lors de la détection: ${error.message}`);
            }
        }
        
        // Affichage des résultats avec visualisation
        function displayResults(detections, ratio, dw, dh) {
            // Créer un canvas pour dessiner les bounding boxes
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = currentImage.width;
            canvas.height = currentImage.height;
            
            // Dessiner l'image originale
            ctx.drawImage(currentImage, 0, 0);
            
            // Dessiner les bounding boxes
            detections.forEach((det, index) => {
                const [x1, y1, x2, y2] = det.bbox;
                const color = `hsl(${(index * 137.5) % 360}, 70%, 50%)`;
                
                // Rectangle
                ctx.strokeStyle = color;
                ctx.lineWidth = 3;
                ctx.strokeRect(x1, y1, x2 - x1, y2 - y1);
                
                // Label
                ctx.fillStyle = color;
                ctx.font = '16px Arial';
                const label = `${det.className} ${(det.confidence * 100).toFixed(1)}%`;
                const textWidth = ctx.measureText(label).width;
                
                ctx.fillRect(x1, y1 - 25, textWidth + 10, 25);
                ctx.fillStyle = 'white';
                ctx.fillText(label, x1 + 5, y1 - 5);
            });
            
            // Afficher les résultats
            const resultHTML = `
                <div class="success">
                    ✅ Détection terminée ! ${detections.length} objet(s) détecté(s)
                </div>
                
                <div style="text-align: center; margin: 20px 0;">
                    <img src="${canvas.toDataURL()}" 
                         style="max-width: 100%; max-height: 600px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);" 
                         alt="Résultat de détection">
                </div>
                
                <div class="detection-info">
                    <h4>📋 Détails des détections :</h4>
                    <div class="detection-list">
                        ${detections.map((det, i) => `
                            <div class="detection-item">
                                <strong>${det.className}</strong><br>
                                Confiance: ${(det.confidence * 100).toFixed(1)}%<br>
                                Position: (${Math.round(det.bbox[0])}, ${Math.round(det.bbox[1])}) - (${Math.round(det.bbox[2])}, ${Math.round(det.bbox[3])})
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            document.getElementById('resultsContent').innerHTML = resultHTML;
            resultsSection.style.display = 'block';
            resultsSection.scrollIntoView({ behavior: 'smooth' });
        }
        
        function showLoading(message) {
            const loadingHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>${message}</p>
                </div>
            `;
            document.getElementById('resultsContent').innerHTML = loadingHTML;
            resultsSection.style.display = 'block';
        }
        
        function showError(message) {
            const errorHTML = `<div class="error">❌ ${message}</div>`;
            document.getElementById('resultsContent').innerHTML = errorHTML;
            resultsSection.style.display = 'block';
        }
    </script>
</body>
</html>
